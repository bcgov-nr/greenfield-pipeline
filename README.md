<!-- PROJECT SHIELDS -->

[![Contributors](https://img.shields.io/github/contributors/bcgov/greenfield-template)](/../../graphs/contributors)
[![Forks](https://img.shields.io/github/forks/bcgov/greenfield-template)](/../../network/members)
[![Stargazers](https://img.shields.io/github/stars/bcgov/greenfield-template)](/../../stargazers)
[![Issues](https://img.shields.io/github/issues/bcgov/greenfield-template)](/../../issues)
[![MIT License](https://img.shields.io/github/license/bcgov/greenfield-template.svg)](/LICENSE.md)
[![Lifecycle](https://img.shields.io/badge/Lifecycle-Experimental-339999)](https://github.com/bcgov/repomountie/blob/master/doc/lifecycle-badges.md)

# greenfield-template
Forestry Client Services' greenfield template.  For testing and demonstration purposes.

The Greenfield-template is a node.js application built with [nestJS](https://docs.nestjs.com), and the main purpose is to provide a [GitHub Actions](https://docs.github.com/en/actions/quickstart) template to automate the process for testing, security scanning, code quality checking, image building and deploying for an application.  

This project is in active development.  Please visit our [issues](https://github.com/bcgov/greenfield-template/issues) page to view or request features.

Currently, our most exciting offering is the [GitHub Actions](https://github.com/bcgov/greenfield-template/actions) [pipeline](https://github.com/bcgov/greenfield-template/blob/main/.github/workflows/pr-open.yml), which includes:

* [Pull Request](https://github.com/bcgov/greenfield-template/pulls)-based ephemeral, sandboxed environments.
* [Docker](https://github.com/marketplace/actions/build-and-push-docker-images)(/Podman) container building.
* [Build caching](https://github.com/marketplace/actions/cache) to save time and bandwidth.
* [GitHub Container Registry](https://github.com/bcgov/greenfield-template/pkgs/container/greenfield-template) image publishing.
* [RedHat OpenShift](https://www.redhat.com/en/technologies/cloud-computing/openshift) deployment, with other options under consideration.
* [OpenShift artifact](https://github.com/bcgov/greenfield-template/blob/main/.github/workflows/pr-close.yml) pruning on PR completion.
* [SonarCloud](https://sonarcloud.io/) continuous code quality and security scanning.
* [GitHub CodeQL](https://codeql.github.com/) semantic code analysis and vulerability scanning.
* [Snyk](https://snyk.io/) development, vulnerability and security scanning.
* [OWASP ZAP](https://owasp.org/www-project-zap/) Zed Attack Proxy security scanning.
* [Jest](https://jestjs.io/) JavaScript testing enforced in-pipeline.
* [ESLint](https://eslint.org/) linting enforced in-pipeline and on code staging.
* [TypeScript](https://www.typescriptlang.org/) strong-typing for JavaScript.

...and more [on the way](https://github.com/bcgov/greenfield-template/issues)!

![Pipeline Action](.github/graphics/pr.png)

### **Apply the template to a new project**:
The following steps show an example of how to create a new repository with the greenfield-template, and how github actions workflow runs in the case of creating a pull request (pr_close.yml), closing a pull request (pr_close.yml), and merging into the main branch (main.yml). We will deploy a simple "Hello World" application to a shared namespace. **Pre-request**: Github account needs to have access to bcgov organization.   
- Create a new repository with Greenfield-template, check codecov option  
- Add a new environment variable “dev” through repo setting -> environments, with the following secrets:  
    ```
    ENV: dev

    NAMESPACE: 245e18-dev (this is a shared namespace for learning purpose, and for real project should use a real namespace)

    OC_TOKEN: get from openshift namespace -> administer view -> user management -> service account -> pipeline token (use the deployer token here for this specific 245e18-dev namespace, normally should use the pipeline token, and they are auto generated by the namespace)
    ```
- Add following repository secrets through repo setting -> secrets -> actions:  
    ```
    OC_SERVER: openshift cluster url

    GHCR_TOKEN: personal access token generated through user setting -> developer settings -> personal access token with the right to repo and write/delete package

    GHCR_USERNAME: GitHub username
    ```
- Create a new branch and switch to that branch
- Comment out the snyk and sonarcloud part in the `.github/workflows/pr_open.yml` file as those need additional access tokens that need to apply for; comment out the sonarcloud part in the `.github/workflows/main.yml` as well
- Update the “Log in to the Container registry” step in the `.github/workflows/pr_open.yml` file, and update the username to be `${{ secrets.GHCR_USERNAME }}`, and password to be `${{ secrets.GHCR_TOKEN }}`
- Try to create a pull request and watch the pipeline running
- If all steps passed, should be able to access the web page, the host is defined in the `.github/pipeline/deploy.yml` file, service and route section; could also access the web page through openshift topology 
- When merge the pull request, the jobs in the pr_close file will do the cleanup  

### **Troubleshooting**:
- If failed to get authentication at the build docker image stage, check if updated to use the secrets [GHCR token and username](https://github.com/marketplace/actions/docker-build-push-action), the default GitHub token might not work
- If failed to authenticate to openshfit at the deploy stage, check if the service account “pipeline” has the right ability to get project and do deploy

### **Additional settings**:
- Add branch protection rule, for example adding one for “main” branch:    

    Select repo settings -> branches -> add rule, select first 2, and for the 2nd one, add “TESTS” so it requires to pass the GitHub Actions tests step, could customize based on needs

- Set auto delete merged branch:    

    Select repo settings -> general, check “Automatically delete head branches” 

- Add team members to the repositroy:  
  
    Select repo settings -> collaborators and teams

- To check the image registry:  

    Within bcgov organization -> select packages -> search greenfield-template, could see a list of images  



**Note**: This greenfeild-template repo provides a basic template to start up a new project, and needs to be customized based on different projects, like run tests for a different language and what secrets to be cleaned up in the cleanup stage or so